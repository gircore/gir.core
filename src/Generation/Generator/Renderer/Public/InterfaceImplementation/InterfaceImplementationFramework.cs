using System.Linq;

namespace Generator.Renderer.Public;

public static class InterfaceImplementationFramework
{
    public static string Render(GirModel.Interface @interface)
    {
        var interfaceName = Model.Interface.GetImplementationName(@interface);
        return $@"
using System;
using GObject;
using System.Runtime.InteropServices;
using System.Runtime.Versioning;

#nullable enable

namespace {Model.Namespace.GetPublicName(@interface.Namespace)};

// AUTOGENERATED FILE - DO NOT MODIFY

{PlatformSupportAttribute.Render(@interface as GirModel.PlatformDependent)}
public sealed partial class {interfaceName} : {GetParent(@interface)}, {@interface.Name}, GObject.InstanceFactory
{{
    protected internal {interfaceName}({GetParentHandle(@interface)} handle) : base(handle) {{ }}

    /// <summary>
    /// Creates a new managed {interfaceName} instance for a given pointer.
    /// </summary>
    public static new {interfaceName} NewFromPointer(System.IntPtr ptr, bool ownsHandle) => ({interfaceName}) GObject.Internal.InstanceWrapper.WrapHandle<{interfaceName}>(ptr, ownsHandle);

    static object GObject.InstanceFactory.Create(IntPtr ptr, bool ownsHandle)
    {{
        var handle = new {GetParentHandle(@interface)}(ptr);
        var obj = new {Model.Interface.GetImplementationName(@interface)}(handle);
        
        GObject.Internal.InstanceCache.AddToggleRef(obj);

        if(ownsHandle)
        {{
            var instance = new GObject.Internal.TypeInstanceUnownedHandle(ptr);
            var type = GObject.Internal.InitiallyUnowned.GetGType();

            if(GObject.Internal.Functions.TypeCheckInstanceIsA(instance,type))
                GObject.Internal.Object.TakeRef(ptr);

            GObject.Internal.Object.Unref(ptr);
        }}

        return obj;
    }}
}}";
    }

    private static string GetParent(GirModel.Interface @interface)
    {
        var parentPrerequisite = @interface.Prerequisites.FirstOrDefault(x => x is GirModel.Class);

        return parentPrerequisite is null
            ? "GObject.Object"
            : Model.ComplexType.GetFullyQualified(parentPrerequisite);
    }

    private static string GetParentHandle(GirModel.Interface @interface)
    {
        var parentPrerequisite = @interface.Prerequisites
            .OfType<GirModel.Class>()
            .FirstOrDefault();

        return parentPrerequisite is null
            ? "GObject.Internal.ObjectHandle"
            : Model.Class.GetFullyQualifiedInternalHandleName(parentPrerequisite);
    }
}
